import Foundation
import SwiftData
import Combine
import OSLog

/// Ana Shared Repository hub'ƒ± - T√ºm shared repository mod√ºllerini koordine eder
/// iOS ve watchOS platformlarƒ± arasƒ±nda ortak data access katmanƒ± saƒülar
@MainActor
public class SharedRepository: ObservableObject {
    public static let shared = SharedRepository()
    
    // MARK: - Sub-Repository References
    
    private let baseRepository = SharedBaseRepository()
    public let userRepository = SharedUserRepository.shared
    public let scheduleRepository = SharedScheduleRepository.shared
    public let sleepEntryRepository = SharedSleepEntryRepository.shared
    
    private let logger = Logger(subsystem: "com.tanercelik.polynap.shared", category: "SharedRepository")
    
    // MARK: - Initialization
    
    private init() {
        logger.debug("üóÇÔ∏è SharedRepository hub ba≈ülatƒ±ldƒ±")
    }
    
    // MARK: - ModelContext Management
    
    /// ModelContext'i t√ºm shared mod√ºllerde ayarlar
    public func setModelContext(_ context: ModelContext) {
        baseRepository.setModelContext(context)
        userRepository.setModelContext(context)
        scheduleRepository.setModelContext(context)
        sleepEntryRepository.setModelContext(context)
        
        logger.debug("üóÇÔ∏è T√ºm shared repository'lerde ModelContext ayarlandƒ±")
    }
    
    /// Merkezi shared ModelContext'e eri≈üim
    public func getModelContext() -> ModelContext? {
        return baseRepository.getModelContext()
    }
    
    // MARK: - User Management (Delegated to SharedUserRepository)
    
    /// Kullanƒ±cƒ± ID'si ile SharedUser nesnesini getirir
    public func getUserById(_ id: UUID) async throws -> SharedUser? {
        return try await userRepository.getUserById(id)
    }
    
    /// Yeni SharedUser olu≈üturur veya mevcut kullanƒ±cƒ±yƒ± getirir
    public func createOrGetUser(id: UUID, 
                               email: String? = nil, 
                               displayName: String? = nil,
                               isAnonymous: Bool = false,
                               isPremium: Bool = false) async throws -> SharedUser {
        return try await userRepository.createOrGetUser(
            id: id,
            email: email,
            displayName: displayName,
            isAnonymous: isAnonymous,
            isPremium: isPremium
        )
    }
    
    /// SharedUser bilgilerini g√ºnceller
    public func updateUser(_ user: SharedUser, 
                          email: String? = nil, 
                          displayName: String? = nil,
                          avatarUrl: String? = nil,
                          isPremium: Bool? = nil,
                          preferences: String? = nil) async throws {
        try await userRepository.updateUser(
            user,
            email: email,
            displayName: displayName,
            avatarUrl: avatarUrl,
            isPremium: isPremium,
            preferences: preferences
        )
    }
    
    // MARK: - Schedule Management (Delegated to SharedScheduleRepository)
    
    /// T√ºm SharedUserSchedule'larƒ± getirir
    public func getAllSchedules() throws -> [SharedUserSchedule] {
        return try scheduleRepository.getAllSchedules()
    }
    
    /// Aktif olan SharedUserSchedule'ƒ± getirir
    public func getActiveSchedule() throws -> SharedUserSchedule? {
        return try scheduleRepository.getActiveSchedule()
    }
    
    /// Belirli kullanƒ±cƒ±nƒ±n SharedUserSchedule'larƒ±nƒ± getirir
    public func getSchedulesForUser(_ userId: UUID) throws -> [SharedUserSchedule] {
        return try scheduleRepository.getSchedulesForUser(userId)
    }
    
    /// Yeni SharedUserSchedule olu≈üturur
    public func createSchedule(user: SharedUser,
                              name: String,
                              description: String? = nil,
                              totalSleepHours: Double? = nil,
                              adaptationPhase: Int? = nil,
                              isActive: Bool = false) async throws -> SharedUserSchedule {
        return try await scheduleRepository.createSchedule(
            user: user,
            name: name,
            description: description,
            totalSleepHours: totalSleepHours,
            adaptationPhase: adaptationPhase,
            isActive: isActive
        )
    }
    
    /// SharedUserSchedule g√ºnceller
    public func updateSchedule(_ schedule: SharedUserSchedule,
                              name: String? = nil,
                              description: String? = nil,
                              totalSleepHours: Double? = nil,
                              adaptationPhase: Int? = nil,
                              isActive: Bool? = nil) async throws {
        try await scheduleRepository.updateSchedule(
            schedule,
            name: name,
            description: description,
            totalSleepHours: totalSleepHours,
            adaptationPhase: adaptationPhase,
            isActive: isActive
        )
    }
    
    /// Belirli schedule'ƒ± aktive eder, diƒüerlerini deaktive eder
    public func setActiveSchedule(_ scheduleId: UUID) async throws {
        try await scheduleRepository.setActiveSchedule(scheduleId)
    }
    
    /// T√ºm schedule'larƒ± deaktive eder
    public func deactivateAllSchedules() async throws {
        try await scheduleRepository.deactivateAllSchedules()
    }
    
    // MARK: - Sleep Block Management (Delegated to SharedScheduleRepository)
    
    /// SharedSleepBlock olu≈üturur
    public func createSleepBlock(schedule: SharedUserSchedule,
                                startTime: String,
                                endTime: String,
                                durationMinutes: Int,
                                isCore: Bool = false,
                                syncId: String? = nil) async throws -> SharedSleepBlock {
        return try await scheduleRepository.createSleepBlock(
            schedule: schedule,
            startTime: startTime,
            endTime: endTime,
            durationMinutes: durationMinutes,
            isCore: isCore,
            syncId: syncId
        )
    }
    
    /// Belirli schedule'a ait SharedSleepBlock'larƒ± getirir
    public func getSleepBlocks(for scheduleId: UUID) throws -> [SharedSleepBlock] {
        return try scheduleRepository.getSleepBlocks(for: scheduleId)
    }
    
    // MARK: - Sleep Entry Management (Delegated to SharedSleepEntryRepository)
    
    /// Yeni SharedSleepEntry olu≈üturur
    public func createSleepEntry(user: SharedUser,
                                date: Date,
                                startTime: Date,
                                endTime: Date,
                                durationMinutes: Int,
                                isCore: Bool,
                                blockId: String? = nil,
                                emoji: String? = nil,
                                rating: Int = 0,
                                syncId: String? = nil) async throws -> SharedSleepEntry {
        return try await sleepEntryRepository.createSleepEntry(
            user: user,
            date: date,
            startTime: startTime,
            endTime: endTime,
            durationMinutes: durationMinutes,
            isCore: isCore,
            blockId: blockId,
            emoji: emoji,
            rating: rating,
            syncId: syncId
        )
    }
    
    /// Belirli bir tarih i√ßin SharedSleepEntry'leri getirir
    public func getSleepEntries(for date: Date) throws -> [SharedSleepEntry] {
        return try sleepEntryRepository.getSleepEntries(for: date)
    }
    
    /// Belirli kullanƒ±cƒ±nƒ±n t√ºm SharedSleepEntry'lerini getirir
    public func getSleepEntriesForUser(_ userId: UUID) throws -> [SharedSleepEntry] {
        return try sleepEntryRepository.getSleepEntriesForUser(userId)
    }
    
    /// SharedSleepEntry'nin kalite puanƒ±nƒ± g√ºnceller
    public func updateSleepQuality(entryId: UUID, rating: Int, emoji: String? = nil) async throws {
        try await sleepEntryRepository.updateSleepQuality(entryId: entryId, rating: rating, emoji: emoji)
    }
    
    /// Son N g√ºn i√ßin uyku istatistiklerini hesaplar
    public func getSleepStatistics(userId: UUID, days: Int = 7) throws -> SleepStatistics {
        return try sleepEntryRepository.getSleepStatistics(userId: userId, days: days)
    }
    
    // MARK: - Convenience Methods
    
    /// Tam sistem saƒülƒ±k kontrol√º (shared models i√ßin)
    public func performSystemHealthCheck() async throws -> SharedSystemHealthReport {
        let userCount = try userRepository.getAllUsers().count
        let scheduleCount = try scheduleRepository.getAllSchedules().count
        let sleepEntryCount = try sleepEntryRepository.getAllSleepEntries().count
        let hasActiveSchedule = try scheduleRepository.getActiveSchedule() != nil
        
        logger.debug("üìä Shared sistem durumu: \(userCount) kullanƒ±cƒ±, \(scheduleCount) program, \(sleepEntryCount) uyku kaydƒ±")
        
        return SharedSystemHealthReport(
            userCount: userCount,
            scheduleCount: scheduleCount,
            sleepEntryCount: sleepEntryCount,
            hasActiveSchedule: hasActiveSchedule
        )
    }
    
    /// Shared ModelContainer olu≈üturur (deprecated - SharedModelContainer.createSharedModelContainer() kullan)
    @available(*, deprecated, message: "Use SharedModelContainer.createSharedModelContainer() instead")
    public static func createSharedModelContainer() throws -> ModelContainer {
        return try SharedModelContainer.createSharedModelContainer()
    }
    
    // MARK: - Direct Sub-Repository Access
    
    /// SharedUserRepository'ye direkt eri≈üim
    public var user: SharedUserRepository {
        return userRepository
    }
    
    /// SharedScheduleRepository'ye direkt eri≈üim
    public var schedule: SharedScheduleRepository {
        return scheduleRepository
    }
    
    /// SharedSleepEntryRepository'ye direkt eri≈üim
    public var sleepEntry: SharedSleepEntryRepository {
        return sleepEntryRepository
    }
}

// MARK: - Shared System Health Report

/// Shared sistem saƒülƒ±k raporu
public struct SharedSystemHealthReport {
    public let userCount: Int
    public let scheduleCount: Int
    public let sleepEntryCount: Int
    public let hasActiveSchedule: Bool
    
    public var isHealthy: Bool {
        return userCount > 0 && scheduleCount > 0
    }
} 